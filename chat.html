<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é–¢è¥¿é›»é‰„ç¤¾å“¡ãƒãƒ£ãƒƒãƒˆ</title>
    <style>
      html,body{overflow-x:hidden;margin:0;font-family:'Noto Sans JP',sans-serif;background:#f6f8f9;color:#333;font-size:18px}
      .top-bar{position:sticky;top:0;width:100%;background:#f6f8f9;padding:20px 0 20px 55px;border-bottom:2px solid #e04040;display:flex;align-items:center;z-index:1000}
      .top-bar .logo{height:100px;object-fit:contain;cursor:pointer}
      #login-box{max-width:450px;margin:50px auto;padding:40px;background:white;border-radius:10px;box-shadow:0 3px 15px rgba(0,0,0,.1);text-align:center;font-size:1.1rem}
      #login-box input{width:85%;padding:14px;border-radius:10px;border:1px solid #ccc;margin-bottom:20px;font-size:1.05rem}
      #login-box button{padding:14px 24px;border-radius:10px;background:#e04040;color:white;font-weight:bold;border:none;cursor:pointer;font-size:1.05rem}
      #chat-container{max-width:900px;margin:50px auto;display:none;flex-direction:column;gap:15px}
      .section-header{display:flex;justify-content:space-between;align-items:center;border-left:8px solid #e04040;padding:15px 20px;background:white;border-radius:12px;font-size:1.6rem;font-weight:bold;box-shadow:0 3px 8px rgba(0,0,0,.1);cursor:pointer}
      .toggle-symbol{font-size:2rem;font-weight:bold;user-select:none}
      .current-user{font-size:1rem;font-weight:normal;color:#555;margin-bottom:20px}
      #chat-box{border:1px solid #ccc;min-height:350px;max-height:600px;overflow-y:auto;padding:20px;background:white;border-radius:12px;font-size:1.05rem;line-height:1.6}
      .chat-input{display:flex;gap:12px;margin-top:10px;flex-wrap:wrap;align-items:center}
      #msg{flex:1 1 auto;min-width:250px;height:50px;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:1.05rem;resize:none;font-family:'Noto Sans JP',sans-serif}
      #img-file{display:none}
      #img-file-label{cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;border:1px solid #ccc;background:#fff}
      #send{padding:14px 24px;border-radius:10px;background:#e04040;color:white;font-weight:bold;border:none;cursor:pointer;font-size:1.1rem}
      .chat-message{padding:10px 14px;border-radius:10px;margin-bottom:10px;border-left:6px solid transparent;background:white;position:relative}
      .chat-message img{max-width:300px;margin-top:8px;border-radius:6px;display:block}
      .self{border:2px solid}
      .meta-line{font-size:1rem;color:#333;font-weight:bold;margin-bottom:6px}
      .text-line{font-size:1.1rem;color:#333;white-space:pre-wrap;margin-left:12px}
      .text-line a{color:#0078ff;text-decoration:underline;word-break:break-all}
      .msg-actions{position:absolute;top:6px;right:8px;display:flex;gap:8px;font-size:.9rem}
      .msg-actions span{cursor:pointer;color:#555;text-decoration:underline}
      .edit-box{margin-top:8px}
      .edit-box textarea{width:95%;height:70px;font-size:1rem;padding:6px;border-radius:6px;border:1px solid #ccc;font-family:'Noto Sans JP',sans-serif;resize:none}
      .edit-box button{margin-top:4px;margin-right:6px;padding:6px 12px;font-size:.95rem;border-radius:6px;border:none;cursor:pointer}
      #preview-img{max-width:150px;max-height:150px;margin-top:8px;border-radius:6px}
      

      /* æŠ•ç¥¨ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
      .vote-box{padding:10px;border-radius:8px;background:#fff;margin-top:8px}
      .vote-question{font-weight:bold;margin-bottom:8px}
      .vote-choices button{padding:14px 24px;border-radius:10px;background:#e04040;color:white;font-weight:bold;border:none;cursor:pointer;font-size:1.1rem}
      .vote-result-row{display:flex;align-items:center;gap:8px;margin:8px 0}
      .vote-bar-wrap{flex:1;background:#eee;border-radius:8px;height:16px;overflow:hidden}
      .vote-bar{height:100%;background:#e04040}
      .vote-count{min-width:36px;text-align:right}

      /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
      #vote-form{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);backdrop-filter:blur(3px);z-index:2000;align-items:center;justify-content:center}
      #vote-form .panel{background:white;padding:20px;border-radius:10px;width:90%;max-width:420px}
      #vote-form input{width:100%;padding:8px;margin-bottom:10px;border-radius:6px;border:1px solid #ccc}
    </style>
  </head>
  <body>
    <header class="top-bar">
      <a href="index.html"><img src="https://i.postimg.cc/hGSYwRwq/z-Xs-KD4El-Ok-DUud-O1762643882-1762643953.png" class="logo" /></a>
    </header>

    <div id="login-box">
      <h2>ç¤¾å“¡ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <input type="text" id="employee-id" placeholder="ç¤¾å“¡IDã‚’å…¥åŠ›" /><br />
      <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" style="color:red;margin-top:10px"></div>
    </div>

    <div id="chat-container">
      <div class="section-header">
    <div id="my-page-title">ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
      <div class="toggle-symbol" style="visibility:hidden">ï¼</div>
    </div>
    <div class="current-user" id="current-user-name"></div>
    <div id="my-page" style="margin-bottom:30px;">
      <div style="margin-top:10px;font-size:1rem;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´</div>
      <input
        type="text"
        id="edit-username"
        style="margin-top:6px;padding:10px;width:300px;border-radius:8px;border:1px solid #ccc;"
        placeholder="æ–°ã—ã„è¡¨ç¤ºå"
      />
      <button
        id="save-username"
        style="margin-left:8px;padding:10px 16px;border-radius:8px;border:none;background:#e04040;color:white;cursor:pointer;">
        å¤‰æ›´
      </button>
      <div id="name-update-msg" style="margin-top:8px;font-size:.9rem;"></div>
    </div>


      <div class="section-header" id="chat-header">
        <div>å…¨ç¤¾å“¡ãƒãƒ£ãƒƒãƒˆ</div>
        <div class="toggle-symbol" id="chat-toggle">ï¼</div>
      </div>
      <div id="chat-box"></div>

      <div class="chat-input" id="chat-input">
        <textarea id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"></textarea>
        <input type="file" id="img-file" accept="*/*" />
        <label for="img-file" id="img-file-label">ğŸ–¼ï¸</label>
        <img id="preview-img" style="display:none" />
        <div id="preview-file-name" style="display:none; margin-top:8px; color:#555; font-size:14px;"></div>

        <label id="vote-create-btn" 
          style="cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;border:1px solid #ccc;background:#fff;">ğŸ—³ï¸
        </label>
        <button id="send">é€ä¿¡</button>
      </div>
    </div>

    <!-- æŠ•ç¥¨ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
    <div id="vote-form">
      <div class="panel">
        <h3>æŠ•ç¥¨ã‚’ä½œæˆ</h3>
        <input id="vote-q" placeholder="è³ªå•" />
        <div id="vote-choices-container">
          <input class="vote-choice" placeholder="é¸æŠè‚¢1" />
          <input class="vote-choice" placeholder="é¸æŠè‚¢2" />
        </div>
        <button id="add-choice-btn" 
          style="margin-top:10px;background:#ddd;border:none;padding:8px;border-radius:6px;"> ï¼‹ é¸æŠè‚¢ã‚’è¿½åŠ 
        </button>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <button id="vote-submit" style="flex:1;background:#e04040;color:white;padding:10px;border:none;border-radius:6px;">ä½œæˆ</button>
          <button id="vote-cancel" style="flex:1;background:#ccc;color:#e04040;padding:10px;border:none;border-radius:6px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: 'AIzaSyCBn05euFWQVdKPSIZrwpUjxSOFphET3TU',
        authDomain: 'chat-a19bc.firebaseapp.com',
        projectId: 'chat-a19bc',
        storageBucket: 'chat-a19bc.firebasestorage.app',
        messagingSenderId: '554571917384',
        appId: '1:554571917384:web:3484a29f475fcf8db7d07d',
        measurementId: 'G-8058H1PRN7',
      };
      const appChat = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore(appChat);

      const employeeConfig = {
        apiKey: 'AIzaSyAWz50WSL2KvCS-0dmjtuGJHztEDR5CsZ8',
        authDomain: 'kandenmember.firebaseapp.com',
        projectId: 'kandenmember',
        storageBucket: 'kandenmember.firebasestorage.app',
        messagingSenderId: '978509582642',
        appId: '1:978509582642:web:d4b4e07ea1a6f5f768872b',
        measurementId: 'G-BFTYSMPKQ5',
      };
      const appEmployee = firebase.initializeApp(employeeConfig, 'employeeApp');
      const employeeDB = firebase.firestore(appEmployee);

      const statusColors = { ç®¡ç†è·: { border: '#e04040', bg: '#f4f4f4' }, ç¥æˆ¸: { border: '#ff66b2', bg: '#ffe6f0' }, æ·¡è·¯: { border: '#ff88ff', bg: '#ffeeff' }, é˜ªåŒ—: { border: '#f00000', bg: '#ffe6e6' }, é˜ªå—: { border: '#f07000', bg: '#fff5e6' }, å¥ˆè‰¯: { border: '#00f000', bg: '#e6ffe6' }, æ»‹è³€: { border: '#00f0f0', bg: '#e6ffff' }, æ±æµ·: { border: '#0000f0', bg: '#e6e6ff' }, æœ¬ç¤¾: { border: '#000000', bg: '#e6e6e6' }, ä¸€èˆ¬: { border: '#000000', bg: '#e6e6e6' } };

      let currentUserID = null,
        currentUserName = null,
        currentUserStatus = null;

      function linkify(text) {
        if (!text) return '';
        return text.replace(/(https?:\/\/[^\s]+)/g, '<a target="_blank" href="$1">$1<\/a>');
      }

      document.getElementById('login-btn').addEventListener('click', async () => {
        const enteredID = document.getElementById('employee-id').value.trim();
        try {
          const doc = await employeeDB.collection('employees').doc(enteredID).get();
          if (!doc.exists) {
            document.getElementById('login-error').textContent = 'ç¤¾å“¡IDãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
            return;
          }
          const data = doc.data();
          currentUserID = enteredID;
          currentUserName = data.name;
          currentUserStatus = data.status;

          document.getElementById('login-box').style.display = 'none';
          document.getElementById('chat-container').style.display = 'flex';
          document.getElementById('my-page-title').textContent = `${currentUserName}ã®ãƒã‚¤ãƒšãƒ¼ã‚¸`;
          document.getElementById('current-user-name').textContent = 'ç¾åœ¨åˆ¶ä½œä¸­ã§ã™ã€‚è¦æœ›ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ãŠå¯„ã›ãã ã•ã„ã€‚';

          initChat();
        } catch (e) {
          console.error(e);
          document.getElementById('login-error').textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
        }
      });

      function formatTime(timestamp) {
        if (!timestamp) return '';
        const d = timestamp.toDate();
        return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
      }

      function resizeImage(file, maxSize = 800) {
        return new Promise((resolve) => {
          const img = new Image();
          const reader = new FileReader();

          reader.onload = (e) => {
            img.src = e.target.result;
          };

          img.onload = () => {
            let width = img.width;
            let height = img.height;

            if (width > maxSize || height > maxSize) {
              const ratio = maxSize / Math.max(width, height);
              width *= ratio;
              height *= ratio;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            const resizedBase64 = canvas.toDataURL('image/jpeg', 0.9);
            resolve(resizedBase64);
          };

          reader.readAsDataURL(file);
        });
      }

      function showVotePreview(question, choiceCount){
        const box = document.getElementById("preview-file-name");
        box.style.display = "block";
        box.style.color = "#e04040";
        box.textContent = `ğŸ—³ï¸ æŠ•ç¥¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼š${question}ï¼ˆé¸æŠè‚¢${choiceCount}ï¼‰`;
      }

      function initChat() {
        const msgInput = document.getElementById('msg');
        const fileInput = document.getElementById('img-file');
        const previewImg = document.getElementById('preview-img');
        const sendBtn = document.getElementById('send');
        const voteCreateBtn = document.getElementById('vote-create-btn');

        fileInput.addEventListener('change', () => {
          const previewFileNameEl = document.getElementById('preview-file-name');
        
          if (fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];

            if (file.type && file.type.startsWith('image/')) {
              // --- ç”»åƒã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º ---
              const r = new FileReader();
              r.onload = (e) => {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
        
                // ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºã¯æ¶ˆã™
                previewFileNameEl.style.display = 'none';
                previewFileNameEl.textContent = '';
              };
              r.readAsDataURL(file);
            } else {
              // --- ç”»åƒä»¥å¤–ã®å ´åˆï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—ã§ãƒ•ã‚¡ã‚¤ãƒ«åã ã‘ ---
              previewImg.style.display = 'none';
              previewImg.src = '';

              previewFileNameEl.textContent = `ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}`;
              previewFileNameEl.style.display = 'block';
            }
          } else {
            // ä½•ã‚‚é¸ã°ã‚Œã¦ã„ãªã„æ™‚
            previewImg.style.display = 'none';
            previewImg.src = '';
            previewFileNameEl.style.display = 'none';
            previewFileNameEl.textContent = '';
          }
        });

        voteCreateBtn.addEventListener('click', () => {
          document.getElementById('vote-form').style.display = 'flex';
        });

        document.getElementById('vote-cancel').addEventListener('click', () => {
          document.getElementById('vote-form').style.display = 'none';
        });

        document.getElementById("add-choice-btn").addEventListener("click", () => {
          const container = document.getElementById("vote-choices-container");
          const count = container.querySelectorAll(".vote-choice").length + 1;
          const input = document.createElement("input");
          input.className = "vote-choice";
          input.placeholder = `é¸æŠè‚¢${count}`;
          input.style.marginTop = "6px";
          container.appendChild(input);
        });

        let pendingVote = null;

        document.getElementById('vote-submit').addEventListener('click', () => {
          const q = document.getElementById('vote-q').value.trim();
          const choiceInputs = document.querySelectorAll('.vote-choice');
          const choices = [...choiceInputs].map(i => i.value.trim()).filter(i => i);
          if (!q || choices.length < 2) {
            alert("è³ªå•ã¨é¸æŠè‚¢2ã¤ä»¥ä¸ŠãŒå¿…è¦ã§ã™");
            return;
          }
          pendingVote = { question: q, choices };
          showVotePreview(q, choices.length);
          // ãƒ•ã‚©ãƒ¼ãƒ é–‰ã˜ã‚‹
          document.getElementById('vote-form').style.display = 'none';
        });

        let isSending = false;

        sendBtn.addEventListener('click', async () => {
          if (isSending) return;

          const text = msgInput.value.trim();
          const file = fileInput.files[0];
          if (!text && !file) return;

          isSending = true;
          sendBtn.disabled = true;

          try {
            // ---- ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†: ç”»åƒã¯ãƒªã‚µã‚¤ã‚ºã€ãã‚Œä»¥å¤–ã¯ dataURL ã‚’ä½œã‚‹ ----
            let fileBase64 = null;
            let fileType = null;
            let fileName = null;

            if (file) {
              fileName = file.name;
              fileType = file.type || '';

              if (fileType.startsWith('image/')) {
                // ç”»åƒã¯æ—¢å­˜ã®ãƒªã‚µã‚¤ã‚ºé–¢æ•°ã‚’ä½¿ã†ï¼ˆæˆ»ã‚Šå€¤ã¯ data URLï¼‰
                fileBase64 = await resizeImage(file, 800);
              } else {
                // ç”»åƒä»¥å¤–ã¯ãã®ã¾ã¾ data URL ã«å¤‰æ›
                fileBase64 = await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = (e) => resolve(e.target.result);
                  reader.onerror = (e) => reject(e);
                  reader.readAsDataURL(file);
                });
              }
            }

            const lastMsgSnap = await db.collection('chat').orderBy('number', 'desc').limit(1).get();
            let newNumber = 1;
            if (!lastMsgSnap.empty) newNumber = (lastMsgSnap.docs[0].data().number || 0) + 1;

            await db.collection('chat').add({
              type: 'message',
              text,
              // äº’æ›æ€§ã®ãŸã‚ imageBase64 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ä½¿ã‚ãšã€æ–°ã—ã fileBase64 ã‚’ä½¿ã†
              fileBase64,
              fileType,
              fileName,
              uid: currentUserID,
              name: currentUserName,
              status: currentUserStatus,
              number: newNumber,
              time: firebase.firestore.FieldValue.serverTimestamp(),
            });

            if (pendingVote) {
              await db.collection('chat').add({
                type: 'vote',
                question: pendingVote.question,
                choices: pendingVote.choices,
                votes: {},
                open: false,
                uid: currentUserID,
                name: currentUserName,
                status: currentUserStatus,
                number: newNumber,
                time: firebase.firestore.FieldValue.serverTimestamp(),
              });
              pendingVote = null;
              previewFileNameEl.style.display = "none";
            }

            // ---- é€ä¿¡å¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¶ˆå» ----
            previewImg.src = "";
            previewImg.style.display = "none";
            const previewFileNameEl = document.getElementById("preview-file-name");
            if (previewFileNameEl) {
              previewFileNameEl.textContent = "";
              previewFileNameEl.style.display = "none";
            }
            // input ã®ä¸­èº«ã‚‚æ¶ˆã™
            fileInput.value = "";

            deleteOldMessages();

            msgInput.value = '';
            fileInput.value = '';
            previewImg.style.display = 'none';
            previewImg.src = '';
          } catch (err) {
            console.error('send error', err);
            alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          } finally {
            isSending = false;
            sendBtn.disabled = false;
          }
        });

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º
        db.collection('chat').orderBy('time').onSnapshot((snapshot) => {
          const chatBox = document.getElementById('chat-box');
          chatBox.innerHTML = '';

          snapshot.forEach((doc) => {
            const data = doc.data();

            // æŠ•ç¥¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
            if (data.type === 'vote') {
              const color = statusColors[data.status] || statusColors['ä¸€èˆ¬'];
              const div = document.createElement('div');
              div.classList.add('chat-message');
              div.style.background = color.bg;
              div.style.borderLeft = `6px solid ${color.border}`;
              div.dataset.id = doc.id;
              if (data.uid === currentUserID) {
                div.classList.add('self');
                div.style.border = `2px solid ${color.border}`;
              }


              const num = data.number ? `${data.number}. ` : '';
              const time = formatTime(data.time);

              // votes ãŒ undefined ã®å ´åˆã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚‹
              const votes = data.votes || {};
              const already = votes[currentUserID] !== undefined;

              let html = `<div class="meta-line">${num}${data.name}ï¼ˆ${time}ï¼‰</div>`;
              html += `<div class="vote-box"><div class="vote-question">${escapeHtml(data.question || '')}</div>`;

              if (!data.open) {
                // é–‹ç¥¨å‰
                if (!already) {
                  html += `<div class="vote-choices">${(data.choices || []).map((c, i) => `<button onclick="vote('${doc.id}', ${i})">${escapeHtml(c)}</button>`).join('')}</div>`;
                } else {
                  html += `<div style="color:#555;margin-top:8px;">æŠ•ç¥¨æ¸ˆã¿</div>`;
                }

                if (data.uid === currentUserID) {
                  html += `<div style="margin-top:8px;"><button onclick="openVote('${doc.id}')" style="background:#e04040;color:#fff;padding:6px 10px;border:none;border-radius:6px;">é–‹ç¥¨</button></div>`;
                }
              } else {
                // é–‹ç¥¨å¾Œ: çµæœè¡¨ç¤ºï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
                const counts = new Array((data.choices || []).length).fill(0);
                for (const u in votes) {
                  const idx = votes[u];
                  if (typeof idx === 'number' && idx >= 0 && idx < counts.length) counts[idx]++;
                }
                const max = Math.max(...counts, 1);
                html += `<div style="margin-top:6px;font-weight:bold;">çµæœ</div>`;
                html += (data.choices || []).map((c, i) => `
                  <div class="vote-result-row">
                    <div style="width:120px;">${escapeHtml(c)}</div>
                    <div class="vote-bar-wrap"><div class="vote-bar" style="width:${(counts[i] / max) * 100}%;"></div></div>
                    <div class="vote-count">${counts[i]}ç¥¨</div>
                  </div>
                `).join('');
              }

              html += `</div>`; // vote-box
              div.innerHTML = html;

              // ä½œæˆè€…ãªã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆæŠ•ç¥¨ç”¨ï¼‰
              if (data.uid === currentUserID) {
                const actions = document.createElement('div');
                actions.classList.add('msg-actions');
                const del = document.createElement('span');
                del.textContent = 'å‰Šé™¤';
                del.style.cursor = 'pointer';
                del.addEventListener('click', () => { if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) db.collection('chat').doc(doc.id).delete(); });
                actions.appendChild(del);
                div.appendChild(actions);
              }

              chatBox.appendChild(div);
              return; // é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”»ã‚’ã‚¹ã‚­ãƒƒãƒ—
            }

            // é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const color = statusColors[data.status] || statusColors['ä¸€èˆ¬'];
            const div = document.createElement('div');
            div.classList.add('chat-message');
            div.style.background = color.bg;
            div.style.borderLeft = `6px solid ${color.border}`;
            div.dataset.id = doc.id;
            const num = data.number ? `${data.number}. ` : '';
            const time = formatTime(data.time);
            // ---- ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºç”¨ HTML ä½œæˆï¼ˆç”»åƒ or ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ï¼‰ ----
            let fileHtml = "";
            const fb = data.fileBase64 || data.imageBase64; // æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ or æ—¢å­˜äº’æ›
            const ft = data.fileType || (data.imageBase64 ? 'image/*' : '');
            const fn = data.fileName || (data.imageBase64 ? 'image' : '');
            if (fb) {
              if (ft && ft.startsWith('image/')) {
                fileHtml = `<img src="${fb}" />`;
              } else {
                // éç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯
                const safeName = fn ? fn.replace(/"/g, '') : 'attachment';
                fileHtml = `
                  <div style="margin-top:8px;">
                    <a href="${fb}" download="${safeName}" style="color:#0078ff;text-decoration:underline;">
                      ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${escapeHtml(safeName)}
                    </a>
                  </div>`;
              }
            }
            div.innerHTML = `<div class="meta-line">${num}${data.name}ï¼ˆ${time}ï¼‰</div><div class="text-line" id="text-${doc.id}">${linkify(data.text)}</div>${fileHtml}`;

            if (data.uid === currentUserID) {
              div.classList.add('self');
              div.style.border = `2px solid ${color.border}`;
              const a = document.createElement('div');
              a.classList.add('msg-actions');
              a.innerHTML = `<span onclick="editMsg('${doc.id}', \`${escapeBackticks(data.text||'')}\`)">ç·¨é›†</span><span onclick="deleteMsg('${doc.id}')">å‰Šé™¤</span>`;
              div.appendChild(a);
            }

            chatBox.appendChild(div);
          });

          // ---- å¼·åˆ¶ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ï¼ˆæœ€ä¸‹éƒ¨å›ºå®šç‰ˆï¼‰ ----
          requestAnimationFrame(() => {
            const chatBox = document.getElementById('chat-box');
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šå¾Œã«ã•ã‚‰ã«1ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã¤
            requestAnimationFrame(() => {
              chatBox.scrollTop = chatBox.scrollHeight;
            });
          });
        });
      }

      function escapeHtml(str){
        if(!str) return '';
        return String(str).replace(/[&<>\"']/g, (s) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]);
      }
      function escapeBackticks(str){ if(!str) return ''; return String(str).replace(/`/g,'\\`'); }

      async function sendVote(question, choices){
        try{
          const lastMsgSnap = await db.collection('chat').orderBy('number','desc').limit(1).get();
          let newNumber = 1;
          if (!lastMsgSnap.empty) newNumber = (lastMsgSnap.docs[0].data().number || 0) + 1;

          await db.collection('chat').add({
            type: 'vote',
            question,
            choices,
            votes: {},
            open: false,
            uid: currentUserID,
            name: currentUserName,
            status: currentUserStatus,
            number: newNumber,
            time: firebase.firestore.FieldValue.serverTimestamp(),
          });
        }catch(e){console.error('sendVote error',e);alert('æŠ•ç¥¨ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');}
      }

      async function vote(id, choiceIndex){
        if(!currentUserID) { alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
        try{
          const docRef = db.collection('chat').doc(id);
          const obj = {};
          obj[`votes.${currentUserID}`] = choiceIndex;
          await docRef.update(obj);
        }catch(e){console.error('vote error',e);alert('æŠ•ç¥¨ã«å¤±æ•—ã—ã¾ã—ãŸ');}
      }

      async function openVote(id){
        try{
          const doc = await db.collection('chat').doc(id).get();
          if(!doc.exists) return;
          const data = doc.data();
          if(data.uid !== currentUserID){ alert('ä½œæˆè€…ã®ã¿é–‹ç¥¨ã§ãã¾ã™'); return; }
          await db.collection('chat').doc(id).update({ open: true });
        }catch(e){console.error('openVote error', e);alert('é–‹ç¥¨ã«å¤±æ•—ã—ã¾ã—ãŸ');}
      }

      async function deleteOldMessages() {
        try {
          // æœ€æ–°200ä»¶ã®æœ€å¾Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          const latest200 = await db.collection('chat')
            .orderBy('time', 'desc')
            .limit(200)
            .get();

          if (latest200.empty) return;

          const lastDoc = latest200.docs[latest200.docs.length - 1];
          const lastTime = lastDoc.data().time;

          if (!lastTime) return;

          // 200ä»¶ã‚ˆã‚Šå‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
          const oldMessages = await db.collection('chat')
            .orderBy('time')
            .endBefore(lastTime)
            .get();

          if (oldMessages.empty) return;

          // ãƒãƒƒãƒå‰Šé™¤
          const batch = db.batch();
          oldMessages.forEach(doc => batch.delete(doc.ref));
          await batch.commit();

          console.log("å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤å®Œäº†");

        } catch (error) {
          console.error("deleteOldMessages error:", error);
        }
      }

      function editMsg(id,oldText){
        const t = document.getElementById(`text-${id}`);
        if(!t) return;
        t.innerHTML = `<div class="edit-box" style="display:flex;gap:8px;margin-top:8px;align-items:flex-start;"><textarea id="edit-area-${id}" style="flex:1;height:70px;">${escapeHtml(oldText)}</textarea><div style="display:flex;gap:4px;flex-direction:column;"><button style="background-color:#e04040;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;" onclick="saveEdit('${id}')">ä¿å­˜</button><button style="background-color:#e0e0e0;color:black;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;" onclick="cancelEdit('${id}',\`${escapeBackticks(oldText)}\`)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>`;
      }

      function saveEdit(id){
        const el = document.getElementById(`edit-area-${id}`);
        if(!el) return;
        const newText = el.value.trim();
        if(newText===''){ if(confirm('ç·¨é›†å¾Œã®å†…å®¹ãŒç©ºã§ã™ã€‚ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) deleteMsg(id); else cancelEdit(id,newText); return; }
        db.collection('chat').doc(id).update({ text: newText });
        cancelEdit(id,newText);
      }

      function cancelEdit(id,text){
        const t = document.getElementById(`text-${id}`);
        if(!t) return;
        t.textContent = text;
      }

      function deleteMsg(id){ if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) db.collection('chat').doc(id).delete(); }
    </script>
  </body>
</html>
